TYPE=TRIGGERS
triggers='CREATE DEFINER=`root`@`%` TRIGGER event_insert_trigger AFTER INSERT ON Events\nFOR EACH ROW\n  BEGIN\n\n  INSERT INTO Events_Hour (EventId,MonitorId,StartTime,DiskSpace) VALUES (NEW.Id,NEW.MonitorId,NEW.StartTime,0);\n  INSERT INTO Events_Day (EventId,MonitorId,StartTime,DiskSpace) VALUES (NEW.Id,NEW.MonitorId,NEW.StartTime,0);\n  INSERT INTO Events_Week (EventId,MonitorId,StartTime,DiskSpace) VALUES (NEW.Id,NEW.MonitorId,NEW.StartTime,0);\n  INSERT INTO Events_Month (EventId,MonitorId,StartTime,DiskSpace) VALUES (NEW.Id,NEW.MonitorId,NEW.StartTime,0);\n  UPDATE Monitors SET\n  HourEvents = COALESCE(HourEvents,0)+1,\n  DayEvents = COALESCE(DayEvents,0)+1,\n  WeekEvents = COALESCE(WeekEvents,0)+1,\n  MonthEvents = COALESCE(MonthEvents,0)+1,\n  TotalEvents = COALESCE(TotalEvents,0)+1\n  WHERE Id=NEW.MonitorId;\nEND' 'CREATE DEFINER=`root`@`%` TRIGGER event_update_trigger AFTER UPDATE ON Events \nFOR EACH ROW\nBEGIN\n  declare diff BIGINT default 0;\n\n  set diff = COALESCE(NEW.DiskSpace,0) - COALESCE(OLD.DiskSpace,0);\n  IF ( NEW.StorageId = OLD.StorageID ) THEN\n    IF ( diff ) THEN\n      UPDATE Storage SET DiskSpace = COALESCE(DiskSpace,0) + diff WHERE Id = OLD.StorageId;\n    END IF;\n  ELSE\n    IF ( NEW.DiskSpace ) THEN\n      UPDATE Storage SET DiskSpace = COALESCE(DiskSpace,0) + NEW.DiskSpace WHERE Id = NEW.StorageId;\n    END IF;\n    IF ( OLD.DiskSpace ) THEN\n      UPDATE Storage SET DiskSpace = COALESCE(DiskSpace,0) - OLD.DiskSpace WHERE Id = OLD.StorageId;\n    END IF;\n  END IF;\n\n  UPDATE Events_Hour SET DiskSpace=NEW.DiskSpace WHERE EventId=NEW.Id;\n  UPDATE Events_Day SET DiskSpace=NEW.DiskSpace WHERE EventId=NEW.Id;\n  UPDATE Events_Week SET DiskSpace=NEW.DiskSpace WHERE EventId=NEW.Id;\n  UPDATE Events_Month SET DiskSpace=NEW.DiskSpace WHERE EventId=NEW.Id;\n\n  IF ( NEW.Archived != OLD.Archived ) THEN\n    IF ( NEW.Archived ) THEN\n      INSERT INTO Events_Archived (EventId,MonitorId,DiskSpace) VALUES (NEW.Id,NEW.MonitorId,NEW.DiskSpace);\n      UPDATE Monitors SET ArchivedEvents = COALESCE(ArchivedEvents,0)+1, ArchivedEventDiskSpace = COALESCE(ArchivedEventDiskSpace,0) + COALESCE(NEW.DiskSpace,0) WHERE Id=NEW.MonitorId;\n    ELSEIF ( OLD.Archived ) THEN\n      DELETE FROM Events_Archived WHERE EventId=OLD.Id;\n      UPDATE Monitors SET ArchivedEvents = COALESCE(ArchivedEvents,0)-1, ArchivedEventDiskSpace = COALESCE(ArchivedEventDiskSpace,0) - COALESCE(OLD.DiskSpace,0) WHERE Id=OLD.MonitorId;\n    ELSE\n      IF ( OLD.DiskSpace != NEW.DiskSpace ) THEN\n        UPDATE Events_Archived SET DiskSpace=NEW.DiskSpace WHERE EventId=NEW.Id;\n        UPDATE Monitors SET\n          ArchivedEventDiskSpace = COALESCE(ArchivedEventDiskSpace,0) - COALESCE(OLD.DiskSpace,0) + COALESCE(NEW.DiskSpace,0)\n          WHERE Id=OLD.MonitorId;\n      END IF;\n    END IF;\n  ELSEIF ( NEW.Archived AND diff ) THEN\n    UPDATE Events_Archived SET DiskSpace=NEW.DiskSpace WHERE EventId=NEW.Id;\n  END IF;\n\n  IF ( diff ) THEN\n    UPDATE Monitors SET TotalEventDiskSpace = COALESCE(TotalEventDiskSpace,0) - COALESCE(OLD.DiskSpace,0) + COALESCE(NEW.DiskSpace,0) WHERE Id=OLD.MonitorId;\n  END IF;\n\nEND' 'CREATE DEFINER=`root`@`%` TRIGGER event_delete_trigger BEFORE DELETE ON Events\nFOR EACH ROW\nBEGIN\n  IF ( OLD.DiskSpace ) THEN\n    UPDATE Storage SET DiskSpace = COALESCE(DiskSpace,0) - CAST(OLD.DiskSpace AS SIGNED) WHERE Id = OLD.StorageId;\n  END IF;\n  DELETE FROM Events_Hour WHERE EventId=OLD.Id;\n  DELETE FROM Events_Day WHERE EventId=OLD.Id;\n  DELETE FROM Events_Week WHERE EventId=OLD.Id;\n  DELETE FROM Events_Month WHERE EventId=OLD.Id;\n  IF ( OLD.Archived ) THEN\n    DELETE FROM Events_Archived WHERE EventId=OLD.Id;\n    UPDATE Monitors SET\n      ArchivedEvents = COALESCE(ArchivedEvents,1) - 1,\n      ArchivedEventDiskSpace = COALESCE(ArchivedEventDiskSpace,0) - COALESCE(OLD.DiskSpace,0),\n      TotalEvents = COALESCE(TotalEvents,1) - 1,\n      TotalEventDiskSpace = COALESCE(TotalEventDiskSpace,0) - COALESCE(OLD.DiskSpace,0)\n      WHERE Id=OLD.MonitorId;\n  ELSE\n    UPDATE Monitors SET\n    TotalEvents = COALESCE(TotalEvents,1)-1,\n    TotalEventDiskSpace=COALESCE(TotalEventDiskSpace,0)-COALESCE(OLD.DiskSpace,0)\n    WHERE Id=OLD.MonitorId;\n  END IF;\nEND'
sql_modes=1073741824 1073741824 1073741824
definers='root@%' 'root@%' 'root@%'
client_cs_names='latin1' 'latin1' 'latin1'
connection_cl_names='latin1_swedish_ci' 'latin1_swedish_ci' 'latin1_swedish_ci'
db_cl_names='latin1_swedish_ci' 'latin1_swedish_ci' 'latin1_swedish_ci'
created=156400589966 156400589965 156400589967
